#+TITLE: My emacs configure
#+KEYWORDS: emacs configure, org-mode

  This is my version of an configuration file for GNU Emacs.

* Package management
The first part of the configuration is to prepare the package management. I am using =use-package= as
the central tool to deal with configuration of the packages.

** Emacs package configuration
In this section, we are configuring the repositories and emacs internal package management. The only
specificity here is that the TLS algorithm is specific for 26.2.1.

#+BEGIN_SRC emacs-lisp
  (require 'package)

  (when (and (= emacs-major-version 26)
             (= emacs-minor-version 2)
             (= emacs-build-number 1))
    (setq gnutls-algorithm-priority "NORMAL:-VERS-TLS1.3"))

  (setq package-enable-at-startup nil
        package-check-signature nil
        package-archives '(("gnu" . "http://mirrors.ustc.edu.cn/elpa/gnu/")
                           ("melpa" . "http://mirrors.ustc.edu.cn/elpa/melpa/")
                           ("org" . "http://mirrors.ustc.edu.cn/elpa/org/"))

        package-archive-priorities  '(("org"      . 15)
                                      ("melpa"        . 10)
                                      ("gnu"     . 5))
        package-check-signature nil)

  (package-initialize)
#+END_SRC

** Load use-package
Here, we are initializing =use-package= in the classic way.
#+BEGIN_SRC emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package))

  (eval-and-compile
      ;;(setq use-package-always-ensure t)
      ;;(setq use-package-always-defer t)
      (setq use-package-always-demand nil)
      (setq use-package-expand-minimally t)
      (setq use-package-verbose t))

#+END_SRC
** Quelpa
Quelpa is super useful for developer package management. Adding the adaptation for the use-package
makes it configuration file proof.

 #+begin_src emacs-lisp
   (use-package quelpa-use-package
     :ensure t
     :init
     (setq quelpa-update-melpa-p nil))
 #+end_src
** Hydra
I use hydra a lot so it is easier to add its support directly in the use-package configuration part.

#+BEGIN_SRC emacs-lisp
  (use-package hydra :ensure t)
  (use-package use-package-hydra
    :ensure t
    :functions
    (hydra-default-pre
     hydra-keyboard-quit
     hydra--call-interactively-remap-maybe
     hydra-show-hint
     hydra-set-transient-map))
#+END_SRC
** General
I introduce general to configure the key management. It is not really used yet, but it will be more and and more.

#+BEGIN_SRC emacs-lisp
  (use-package general
    :ensure t)
#+END_SRC

** Paradox to enhance package list management
Finally, I use paradox to enhance the package listing experience.
#+BEGIN_SRC emacs-lisp
  ;; A modern Packages Menu
  (use-package paradox
    :ensure t
    :init
    (setq paradox-execute-asynchronously t)
    (setq paradox-github-token t)
    (setq paradox-display-star-count nil))
#+END_SRC


* Helpers
I need to define some helpers to be able to facilitate the configuration. This mainly introduce
user/password management.

** Define some important variables
#+BEGIN_SRC emacs-lisp
  ;; Define root directory and add the plugins
  (defvar default-plugin-dir (format "%s/plugins" user-emacs-directory)
    "The plugins directory")
  (add-to-list 'load-path default-plugin-dir)
  (add-to-list 'load-path "~/.emacs.d/site-lisp/")

  ;; Don't screw up my files with custom
  (setq custom-file (format "%s/custom.el" user-emacs-directory))
  (load custom-file 'noerror)

  ;; Give focus to new help windows
  (setq help-window-select t)
  ;; Put apropos in current buffer so it can be read and exited with minimum effort
  (add-to-list 'display-buffer-alist
              '("*Apropos*" display-buffer-same-window)
              '("*Info*" display-buffer-same-window))

  ;; Add /usr/local/bin to the path
  (setq exec-path (append exec-path '("/usr/local/bin")))

  ;; Y or n is enough for me
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; Silence!!!!!!
  (setq save-abbrevs 'silently
    ad-redefinition-action 'accept
    ;; Garbage collection (see https://github.com/jethrokuan/.emacs.d/blob/master/config.org)
    gc-cons-threshold 50000000
    large-file-warning-threshold 100000000)

#+END_SRC
** Identification helper
Easy use wrapper around auth-* authentification emacs utils.

#+begin_src emacs-lisp
(cl-defun my:auth-source-get-user (&rest spec &allow-other-keys)
  "Helper to get the user given the SPEC from authsource."
  (let ((founds (apply 'auth-source-search spec)))
    (when founds
      (plist-get (nth 0 founds) :user))))

(cl-defun my:auth-source-get-passwd (&rest spec &allow-other-keys)
  "Helper to get the password given the SPEC from authsource."
  (let ((founds (apply 'auth-source-search spec)))
    (when founds
      (funcall (plist-get (nth 0 founds) :secret)))))
#+end_src

** Helpers
I define here some global helpers used either in the rest of the file, either available to use at runtime

*** Editing as root
Defining a simple helper to edit file as root using tramp

#+begin_src emacs-lisp
  (defun edit-current-file-as-root ()
    "Edit the file that is associated with the current buffer as root"
    (interactive)
    (if (buffer-file-name)
        (find-file (concat "/sudo:localhost:" (buffer-file-name)))
      (message "Current buffer does not have an associated file.")))
#+end_src
** Helper Keybinding
#+begin_src emacs-lisp
  (defhydra hydra-main (:color teal :hint nil)
    "
    Main helper

    Org. related          Help                Zooming        bookmarks          other helpers     completion
    ------------------------------------------------------------------------------------------------------------------
    _c_: org-capture        _f_: function doc.    _+_: zoom in     _b_: list bookmarks  _p_: prodigy        _y_: ivy-yasnippet
    _g_: org-web-get-url    _v_: variable doc.    _-_: zoom out    _B_: bookmark file   _m_: new mail

    Backups                       Feed
    ------------------------------------------------------------------------------------------------------------------
    _s_: list backups             _e_: elfeed
    _S_: snapshot timemachine

    "
    ("B" bookmark-set)
    ("b" list-bookmarks)
    ("c" counsel-org-capture)
    ("f" describe-function)
    ("e" elfeed)
    ("g" org-web-tools-read-url-as-org)
    ("m" mu4e-compose-new)
    ("p" prodigy)
    ("s" snapshot-timeline)
    ("S" snapshot-timemachine)
    ("v" describe-variable)
    ("y" ivy-yasnippet)
    ("+" text-scale-increase :color pink)
    ("-" text-scale-decrease :color pink)
    ("<ESC>" nil "quit" :color blue)
    ("q"   nil "cancel" :color blue))

  (global-set-key (kbd "<f1>") 'hydra-main/body)
#+end_src
* emacs concept
** coding system
#+begin_src emacs-lisp
  (prefer-coding-system 'gb2312)
  (prefer-coding-system 'utf-8)
#+end_src
** theme and mode line
#+begin_src emacs-lisp
  (use-package srcery-theme
    :ensure t
    :config
    (load-theme 'srcery t))

  ;; Modeline
  (use-package doom-modeline
    :ensure t
    :custom
    (doom-modeline-buffer-file-name-style 'truncate-with-project)
    (doom-modeline-buffer-name t)
    (doom-modeline-icon t)
    (doom-modeline-major-mode-icon t)
    (doom-modeline-minor-modes nil)
    (doom-modeline-height 15)
    ; use unicode as a fallback (instead of ASCII) when not using icons
    (setq doom-modeline-unicode-fallback t)
    ; don't display the buffer encoding
    (setq doom-modeline-buffer-encoding nil)
    :config
    (set-cursor-color "cyan")
    (line-number-mode 0)
    (column-number-mode 0)
    :init (doom-modeline-mode 1))

  (use-package hide-mode-line
    :ensure t
    :hook
    ((neotree-mode imenu-list-minor-mode minimap-mode) . hide-mode-line-mode))
#+end_src
** Icons
#+begin_src emacs-lisp
(use-package all-the-icons
  :ensure t)

(use-package all-the-icons-dired
  :ensure t
  :config (add-hook 'dired-mode-hook 'all-the-icons-dired-mode))

(use-package all-the-icons-ivy
  :ensure t
  :init (add-hook 'after-init-hook 'all-the-icons-ivy-setup))
#+end_src
** Fonts
#+begin_src shell :tangle no
sudo pacman -S ttf-fira-code
sudo pacman -S nerd-fonts-fira-code
#+end_src
#+begin_src emacs-lisp
(require 'dash)
  (defun set-icon-fonts (CODE-FONT-ALIST)
    "Utility to associate many unicode points with specified fonts."
    (--each CODE-FONT-ALIST
      (-let (((font . codes) it))
        (--each codes
          (set-fontset-font t `(,it . ,it) font)))))

  (defun load-default-fonts ()

    ;;(set-fontset-font "fontset-default" 'unicode "Dejavu Sans Mono")
    (set-fontset-font "fontset-default" 'unicode "Fira Code Nerd Font")

    ;; The icons you see are not the correct icons until this is evaluated!
    (set-icon-fonts
     '(("fontawesome"
        ;; ï¼   ïƒ‰     ïƒ„     ï‚›      ï€—     ï„
        #xf07c #xf0c9 #xf0c4 #xf0cb #xf017 #xf101)

       ("all-the-icons"
        ;; î¤‡   î¤¨
        #xe907 #xe928)

       ("github-octicons"
        ;; ï‚‘   ï™     ï¶     ïµ     ï€–     ï€Š
        #xf091 #xf059 #xf076 #xf075 #xf016 #xf00a)

       ("Symbola"
        ;; ğ•Š    â¨‚      âˆ…      âŸ»    âŸ¼     âŠ™      ğ•‹       ğ”½
        #x1d54a #x2a02 #x2205 #x27fb #x27fc #x2299 #x1d54b #x1d53d
        ;; ğ”¹    ğ”‡       ğ”—
        #x1d539 #x1d507 #x1d517))))


  (defun load-fonts (frame)
    (select-frame frame)
    (load-default-fonts))

  (if (daemonp)
      (add-hook 'after-make-frame-functions #'load-fonts)
    (load-default-fonts))
#+end_src
** frame
*** Title
#+begin_src emacs-lisp
(defun frame-title-format ()
  "Return frame title with current project name, where applicable."
  (let ((file buffer-file-name))
    (if file
        (if (and (bound-and-true-p projectile-mode)
                 (projectile-project-p))
            (concat
             (format "[%s] " (projectile-project-name))
             (replace-regexp-in-string (format "^%s" (projectile-project-p)) "" (file-truename file)))
          (abbreviate-file-name file))
      "%b")))

(when (display-graphic-p)
  (setq frame-title-format '("" " Happy Hacking â˜º "(:eval (frame-title-format)))))

#+end_src
*** Remove unused part
#+begin_src emacs-lisp
  ;; Prevent the startup window
  (setq inhibit-startup-message t)

  ;; No alarms.
  (setq ring-bell-function 'ignore)

  ;; When on a tab, make the cursor the tab lengthâ€¦
  (setq-default x-stretch-cursor t)

  ;; Permanently force Emacs to indent with spaces, never with TABs
  (set-default 'indent-tabs-mode nil)

  ;; Except in Makefiles.
  (add-hook 'makefile-mode-hook 'indent-tabs-mode)

  ;; Setup fullscreen when startup
  (add-to-list 'default-frame-alist '(fullscreen . maximized))
#+end_src

** window
*** Split Buffers Side-by-Side
#+begin_src emacs-lisp
;;emacsä¼šæ ¹æ®ä½ çš„ç”µè„‘å±å¹•é•¿å®½æ¯”è‡ªåŠ¨è°ƒæ•´æ—¶ä¸Šä¸‹åˆ†å±è¿˜æ˜¯å·¦å³åˆ†ï¼Œå¦‚æœæƒ³å¼ºåˆ¶å·¦å³åˆ†å¯ä»¥è¿™æ ·è®¾ç½®ï¼š
(setq split-height-threshold nil)
(setq split-width-threshold 0)
#+end_src
** minibuffer
#+begin_src emacs-lisp :tangle no
  (use-package minibuffer
    ;; :hook
    ;; (eval-expression-minibuffer-setup .  #'eldoc-mode)
    :ensure t
    :config
    (setq read-file-name-completion-ignore-case t
          completion-ignore-case t
          resize-mini-windows t)

    (file-name-shadow-mode 1))
#+end_src

*** Maple minibuffer
#+begin_src emacs-lisp :tangle no
  (use-package maple-minibuffer
    :disabled t
    :ensure quelpa
    :quelpa (maple-minibuffer :fetcher github :repo "honmaple/emacs-maple-minibuffer")
    :hook
    (after-init . maple-minibuffer-mode)

    :custom
    (maple-minibuffer:position-type 'frame-center)
    (maple-minibuffer:width 0.7)
    (maple-minibuffer:action '(read-from-minibuffer read-string))
    (maple-minibuffer:ignore-action '(evil-ex eval-expression org-schedule))
    (maple-minibuffer:ignore-regexp '("^helm-"))

    :config
    ;; more custom parameters for frame
    (defun maple-minibuffer:parameters ()
      "Maple minibuffer parameters."
      `((height . ,(or maple-minibuffer:height 10))
        (width . ,(or maple-minibuffer:width (window-pixel-width)))
        (left-fringe . 5)
        (right-fringe . 5))))

#+end_src
** line numbers and whitespace indicators

*Display line numbers (buffer-local)*
  I seldom use line numbers, but here it is.  This toggles the setting for the local buffer and also activates /hl-line-mode/.
*Display invisible characters (whitespace)*
  Viewing invisible characters (whitespace) can be very helpful under certain circumstances.  Generally though, I do not keep it active.

As for /delete-trailing-whitespace/, I prefer to call it manually because sometimes it causes problems, such as with diffs.
#+begin_src emacs-lisp
   ;; Turn on line numbers
   ;; (global-display-line-numbers-mode)
   ;; (menu-bar-display-line-numbers-mode 'relative)
  (if (version< emacs-version "26")
      (global-linum-mode)
    (add-hook 'text-mode-hook #'display-line-numbers-mode)
    (add-hook 'prog-mode-hook #'display-line-numbers-mode))

  (use-package display-line-numbers
    :config
    ;; Set absolute line numbers.  A value of "relative" is also useful.
    (setq display-line-numbers-type t)
    ;; Those two variables were introduced in Emacs 27.1
    (setq display-line-numbers-major-tick 0)
    (setq display-line-numbers-minor-tick 0)
    ;; Use absolute numbers in narrowed buffers
    (setq display-line-numbers-widen t)

    (define-minor-mode my/display-line-numbers-mode
      "Toggle `display-line-numbers-mode' and `hl-line-mode'."
      :init-value nil
      :global nil
      (if my/display-line-numbers-mode
          (progn
            (display-line-numbers-mode 1)
            (hl-line-mode 1)
            (setq-local truncate-lines t))
        (display-line-numbers-mode -1)
        (hl-line-mode -1)
        (setq-local truncate-lines nil)))
    :bind ("<f11>" . my/display-line-numbers-mode))

  (use-package whitespace
    :config
    (defun my/toggle-invisibles ()
      "Toggles the display of indentation and space characters."
      (interactive)
      (if (bound-and-true-p whitespace-mode)
          (whitespace-mode -1)
        (whitespace-mode)))
    :bind (("<f6>" . my/toggle-invisibles)
           ("C-c z" . delete-trailing-whitespace)))
  ;; ä¿å­˜æ—¶è‡ªåŠ¨æ¸…é™¤è¡Œå°¾ç©ºæ ¼åŠæ–‡ä»¶ç»“å°¾ç©ºè¡Œ trailing-whitespace: æ‹–å°¾ç©ºæ ¼ï¼Œç»“å°¾ç©ºæ ¼
  ;;(add-hook 'before-save-hook 'delete-trailing-whitespace)
#+end_src

** Buffer
*** Column/line
The column count is set to 72. The standard line length is 80 characters,
so having it at something less allows for such things as quoting plain text, indenting, etc.
git commit messages also make good use of this method.
The column count is used by auto-fill-mode and similar tools
(or when manually invoking text formatting with fill-paragraph or equivalentâ€”normally bound to M-q).
#+begin_src emacs-lisp
  ;; Redefine fill-column as my screen is not 80 chars :D
  ;;(setq-default fill-column 100)
  (use-package emacs
    :ensure nil
    :config
    (setq-default fill-column 72)
    :hook (after-init-hook . column-number-mode))


  (use-package emacs
    :ensure nil
    :diminish auto-fill-function
    :config
    (setq adaptive-fill-mode t)
    :hook (text-mode-hook . turn-on-auto-fill)
    (org-mode-hook . turn-on-auto-fill))

  (use-package fill-column-indicator
    :ensure t
    :config
    ;; Define a global mode but not sure I am going to use it
      (define-globalized-minor-mode
         global-fci-mode fci-mode
          (lambda ()
            (fci-mode 1))))

  (use-package visual-fill-column
    :ensure t)

  ;; See column-number
  (column-number-mode t)
  (size-indication-mode t)
#+end_src
*** Paging
#+begin_src emacs-lisp
  (use-package page-break-lines
    :ensure t
    :diminish page-break-lines-mode
    :config
    (global-page-break-lines-mode t))
#+end_src
*** Parenthesis
**** Smart parents
#+begin_src emacs-lisp
  (use-package smartparens
    :ensure t
    :config
    (require 'smartparens-config)
    ;; Activate smartparens globally
    (smartparens-global-mode t)
    (show-smartparens-global-mode t))
#+end_src
#+begin_src emacs-lisp :tangle no
  (use-package smartparens
    :ensure t
    :config
    ;; Activate smartparens globally
    (smartparens-global-mode t)
    (show-smartparens-global-mode t)

    ;; Activate smartparens in minibuffer
    (add-hook 'eval-expression-minibuffer-setup-hook #'smartparens-mode)

    ;; Do not pair simple quotes
    (sp-pair "'" nil :actions :rem))

  ;;[[Newline and indent on appropriate pairs][https://github.com/Fuco1/smartparens/issues/80]]
  (sp-local-pair '(c-mode) "{" nil :post-handlers '((my-create-newline-and-enter-sexp "RET")))
  (sp-local-pair 'c++-mode "{" nil :post-handlers '((my-create-newline-and-enter-sexp "RET")))

  (defun my-create-newline-and-enter-sexp (&rest _ignored)
    "Open a new brace or bracket expression, with relevant newlines and indent. "
    (newline)
    (indent-according-to-mode)
    (forward-line -1)
    (indent-according-to-mode))
#+end_src

**** Rainbow delimiter
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :ensure t
  :hook
  (prog-mode . rainbow-delimiters-mode))
#+end_src

*** Show current function
#+begin_src emacs-lisp
  (which-function-mode 1)
#+end_src

*** Diff
#+begin_src emacs-lisp
(use-package diff-hl
  :ensure t
  :hook
  (dired-mode . diff-hl-dired-mode-unless-remote)

  :config
  (global-diff-hl-mode)
  (fringe-mode 10))
#+end_src
*** buffer move
#+begin_src emacs-lisp
;;(define-prefix-command 'leader-key)
;;(global-set-key (kbd "M-SPC") 'leader-key)
(use-package buffer-move
  :ensure t
  :config)
  ;;(global-set-key (kbd "<C-S-up>")     'buf-move-up)
  ;;(global-set-key (kbd "<C-S-down>")   'buf-move-down)
  ;;(global-set-key (kbd "<C-S-left>")   'buf-move-left)
  ;;(global-set-key (kbd "<C-S-right>")  'buf-move-right))
(use-package windmove
  :ensure t
  :init (windmove-default-keybindings)
  :config
  :bind       ("C-x w f" . #'buf-move-right)
  :bind       ("C-x w b" . #'buf-move-left)
  :bind       ("C-x w p" . #'buf-move-up)
  :bind       ("C-x w n" . #'buf-move-down))
#+end_src
*** Faces/Colors
**** Rainbow
#+begin_src emacs-lisp
(use-package rainbow-mode
  :ensure t
  :commands (rainbow-mode))
#+end_src

**** COMMENT Terminal
#+begin_src emacs-lisp
  (set-face-foreground 'term-color-black "#4d4d4d")
  (set-face-foreground 'term-color-red "#cc9393")
  (set-face-foreground 'term-color-green "#7f9f7f")
  (set-face-foreground 'term-color-yellow "#f0dfaf")
  (set-face-foreground 'term-color-blue "#4169e1")
  (set-face-foreground 'term-color-magenta "#dc8cc3")
  (set-face-foreground 'term-color-cyan "#93e0e3")
  (set-face-foreground 'term-color-white "#dcdccc")
#+end_src
**** Dired (using dired-rainbow)
#+begin_src emacs-lisp
  (use-package dired-rainbow
    :ensure t
    :init
    (eval-after-load 'dired '(require 'dired-rainbow))

    :config

    (defconst dired-audio-files-extensions
      '("mp3" "MP3" "ogg" "OGG" "flac" "FLAC" "wav" "WAV")
      "Dired Audio files extensions")
    (dired-rainbow-define audio "#329EE8" dired-audio-files-extensions)

    (defconst dired-video-files-extensions
      '("vob" "VOB" "mkv" "MKV" "mpe" "mpg" "MPG" "mp4" "MP4" "ts" "TS" "m2ts"
        "M2TS" "avi" "AVI" "mov" "MOV" "wmv" "asf" "m2v" "m4v" "mpeg" "MPEG" "tp")
      "Dired Video files extensions")
    (dired-rainbow-define video "#455AFC" dired-video-files-extensions)

    (dired-rainbow-define html "#4e9a06" ("htm" "html" "xhtml"))
    (dired-rainbow-define xml "DarkGreen" ("xml" "xsd" "xsl" "xslt" "wsdl"))

    (dired-rainbow-define document "#ce5c00" ("doc" "docx" "odt" "pdb" "pdf" "ps" "rtf" "djvu"))
    (dired-rainbow-define image "#ff4b4b" ("jpg" "png" "jpeg" "gif"))

    (dired-rainbow-define sourcefile "#3F82FD" ("el" "groovy" "gradle" "py" "c" "cc" "h" "java" "pl" "rb"))

    (dired-rainbow-define executable "#8cc4ff" ("exe" "msi"))
    (dired-rainbow-define compressed "#ad7fa8" ("zip" "bz2" "tgz" "txz" "gz" "xz" "z" "Z" "jar" "war" "ear" "rar" "sar" "xpi" "apk" "xz" "tar"))
    (dired-rainbow-define packaged "#e6a8df" ("deb" "rpm"))
    (dired-rainbow-define encrypted "LightBlue" ("gpg" "pgp"))

    (dired-rainbow-define-chmod executable-unix "Green" "-.*x.*")

    (dired-rainbow-define log (:inherit default :italic t) ".*\\.log")
    )
#+end_src

*** Emoji
#+begin_src emacs-lisp
    (use-package emojify
      :ensure t
      :functions (emojify-set-emoji-data)
      :hook (circe-chat-mode . emojify-mode)
      :config

      (setq emojify-user-emojis
            '(("(heart)" . (("name" . "Heart")
                            ("image" . "~/.emacs.d/emojis/emojione-v2.2.6-22/2665.png")
                            ("style" . "github")))))

      ;; If emojify is already loaded refresh emoji data
      (when (featurep 'emojify)
        (emojify-set-emoji-data)))

    (use-package company-emoji
      :ensure t)

    (use-package flycheck-status-emoji
      :ensure t)
#+end_src
Some buffer specificities configuration like how to deal with trailing whitespaces or the
fill-column for example.
*** uniquify
#+begin_src emacs-lisp
;; Unify the buffer name style
(use-package uniquify
  :config
  (setq uniquify-buffer-name-style 'post-forward-angle-brackets)
  (setq uniquify-strip-common-suffix t)
  (setq uniquify-after-kill-buffer-p t))
#+end_src
*** vlf
#+begin_src emacs-lisp
;; Open Large file
(use-package vlf
  :ensure t
  :config
  (require 'vlf-setup))
#+end_src
*** auto revert
#+begin_src emacs-lisp
  ;; Automatically reload files was modified by external program
  (use-package autorevert
    :ensure nil
    :diminish
    :hook (after-init . global-auto-revert-mode))
#+end_src
** Ibuffer
*** Helpers
#+begin_src emacs-lisp
  (defun ibuffer-clean ()
    "Clean automatically created buffers"
    (interactive)
    (ibuffer-unmark-all ?*)
    (ibuffer-mark-by-mode 'help-mode)
    (ibuffer-mark-by-mode 'magit-mode)
    (ibuffer-mark-by-mode 'occur-mode)
    (ibuffer-mark-by-mode 'grep-mode)
    (ibuffer-mark-by-mode 'dired-mode)
    (ibuffer-mark-by-mode 'completion-list-mode)
    (ibuffer-mark-by-mode 'compilation-mode)
    (ibuffer-mark-by-mode 'Man-mode)
    (ibuffer-mark-by-mode 'browse-kill-ring-mode)
    (ibuffer-mark-by-name-regexp "*anything*")
    (ibuffer-mark-by-name-regexp "*ESS*")
    (ibuffer-mark-by-name-regexp "*Shell Command Output*")
    (ibuffer-mark-by-name-regexp "*Compile-Log*")
    (ibuffer-mark-by-name-regexp "*vc-diff*")
    (ibuffer-do-delete))
#+END_SRC

** tab
#+begin_src emacs-lisp
;;(setq tab-bar-close-button-show nil)
#+end_src
** cursor and mouse
#+begin_src emacs-lisp
;; è®¾ç½®å…‰æ ‡é¢œè‰²
;;(set-cursor-color "green2")
;; è®¾ç½®å…‰æ ‡æ ·å¼
;;(setq-default cursor-type 'box)

(use-package frame
  :commands my/cursor-type-mode
  :config
  (setq-default cursor-type 'box)
  (setq-default cursor-in-non-selected-windows '(bar . 2))
  (setq-default blink-cursor-blinks 50)
  (setq-default blink-cursor-interval nil) ; 0.75 would be my choice
  (setq-default blink-cursor-delay 0.2)

  (blink-cursor-mode -1)

  (define-minor-mode my/cursor-type-mode
    "Toggle between static block and pulsing bar cursor."
    :init-value nil
    :global t
    (if my/cursor-type-mode
        (progn
          (setq-local blink-cursor-interval 0.75
                      cursor-type '(bar . 2)
                      cursor-in-non-selected-windows 'hollow)
          (blink-cursor-mode 1))
      (dolist (local '(blink-cursor-interval
                       cursor-type
                       cursor-in-non-selected-windows))
        (kill-local-variable `,local))
      (blink-cursor-mode -1))))
#+end_src

Never lose your cursor again
#+begin_src emacs-lisp
;; åˆ‡æ¢bufferç„¦ç‚¹æ—¶é«˜äº®åŠ¨ç”»
(use-package  beacon
  :ensure t
  :hook (after-init . beacon-mode))
#+end_src

** Highlight
#+begin_src emacs-lisp
  ;; Parenthesis
  (use-package highlight-parentheses
    :ensure t
    :diminish 'highlight-parentheses-mode
    :config
    (add-hook 'prog-mode-hook #'highlight-parentheses-mode))

  ;; Highlight numbers for prog modes
  (use-package highlight-numbers
    :ensure t
    :init
    (add-hook 'prog-mode-hook 'highlight-numbers-mode))

  (use-package auto-highlight-symbol
    :ensure t
    :config
    (global-auto-highlight-symbol-mode t))

  ;; Always hightlight current line
  ;;(global-hl-line-mode t)
#+end_src
** Minor-mode activation
I use some minor modes based on some filetypes. This package is an helper which facilitates these
activations.

#+begin_src emacs-lisp
(use-package auto-minor-mode
  :ensure t)
#+end_src
** mark and region
The mark ring
æ¯æ¬¡ä½ è·³è½¬äº†å…‰æ ‡(æ–‡æœ¬æœç´¢æˆ–è€…æŒ‰ä¸‹äº† M-<æˆ– M->)ï¼Œ
Emacsä½¿ç”¨markæ ‡è®°ä¸‹ä½ çš„å‰ä¸€ä¸ªä½ç½®.
C-x C-x exchange-point-and-mark
** bookmark
** register
** mode
** Undo
#+BEGIN_SRC emacs-lisp
;; Undo-tree
(use-package undo-tree
  :config
  (setq undo-tree-visualizer-timestamps t)
  (setq undo-tree-visualizer-diff t)
  (setq undo-tree-auto-save-history t)
  ;; save all undo histories to this location
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo")))
  (defadvice undo-tree-make-history-save-file-name
      (after undo-tree activate)
    (setq ad-return-value (concat ad-return-value ".gz")))
  (global-undo-tree-mode)
  :defer t
  :diminish 'undo-tree-mode)
#+END_SRC

** recent file
Opening recent files is always an easy and fast shortcut. Some files should be ignored though. That
leads to this configuration

#+begin_src emacs-lisp
;; Builds a list of recently opened files
(use-package recentf
  :ensure t
  :config
  (setq recentf-max-saved-items 100
        recentf-max-menu-items 5
        recentf-save-file (concat user-emacs-directory ".cache/recentf")
        recentf-auto-cleanup 'never)
  (recentf-mode 1)

  (add-to-list 'recentf-exclude (expand-file-name package-user-dir))
  (add-to-list 'recentf-exclude "COMMIT_EDITMSG\\'")
  (add-to-list 'recentf-exclude (expand-file-name (concat user-emacs-directory ".cache/")))
  (add-hook 'delete-terminal-functions (lambda (terminal) (recentf-save-list))))

#+END_SRC
** backups file
  When Emacs makes a backup file, its name is normally constructed by
  appending â€˜~â€™ to the file name being edited; thus, the backup file for
  â€˜eval.câ€™ would be â€˜eval.c~â€™.
#+begin_src emacs-lisp
  (setq make-backup-files nil)
#+end_src
** auto-save
  Normally, the auto-save file name is made by appending â€˜#â€™ to the
front and rear of the visited file name.  Thus, a buffer visiting file
â€˜foo.câ€™ is auto-saved in a file â€˜#foo.c#â€™.
  #+begin_src emacs-lisp
    ;;The variable â€˜auto-save-intervalâ€™ specifies how many characters there are between auto-saves.
    (setq-default auto-save-interval 100);;By default, it is 300.
    ;;Auto-saving also takes place when you stop typing for a while.
    (setq-default auto-save-timeout 15) ;;By default, it is 30 seconds.

    (defvar auto-save-directory "~/.emacs.d/auto-save/")
    (setq auto-save-file-name-transforms `((".*" ,auto-save-directory t)))

    (when (not (file-exists-p auto-save-directory))
      (make-directory auto-save-directory t))
  #+end_src
** Editing
*** Navigation
#+begin_src emacs-lisp
  (use-package emacs
    :ensure nil
    :config
    ;;(setq-default scroll-preserve-screen-position t)
    (setq-default scroll-conservatively 101) ; affects `scroll-step'
    (setq-default scroll-margin 0))
#+end_src

**** Preview
First, instead of jumping we simply can preview the jump.

#+BEGIN_SRC emacs-lisp
  (use-package goto-line-preview
    :ensure t
    :commands (goto-line-preview)
    :bind
    (("M-g g" . goto-line-preview)))
#+END_SRC
**** Ace jump
#+BEGIN_SRC emacs-lisp
  ;; Windows management: Quickly switch windows in Emacs
  (use-package ace-window
    :ensure t
    :init
    (progn
      (global-set-key [remap other-window] 'ace-window)
      (custom-set-faces
       '(aw-leading-char-face
         ((t (:inherit ace-jump-face-foreguound :height 3.0 :foreground "red")))))
      ))
  (use-package ace-jump-mode
    :ensure t
    :config
    (define-key global-map (kbd "C-c SPC") 'ace-jump-mode))
#+END_SRC
**** Remember last jump
Also, I tend to jump a lot for quick modification. So remembering the jump is absolute crucial in my
workflow.

#+BEGIN_SRC emacs-lisp
  (use-package goto-last-point
    :ensure t
    :functions (goto-last-point-mode)
    ;;:bind ("C-<" . goto-last-point)
    :config (goto-last-point-mode))
#+END_SRC
*** Searching
Double-saber is really helpful to reduce the result of a search after the search itself.

#+BEGIN_SRC emacs-lisp
  (use-package double-saber
    :ensure t
    :config
    (with-eval-after-load "ripgrep"
      (add-hook 'ripgrep-search-mode-hook
                (lambda ()
                  (double-saber-mode)
                  (setq-local double-saber-start-line 5)
                  (setq-local double-saber-end-text "Ripgrep finished"))))

    (with-eval-after-load "grep"
      (add-hook 'grep-mode-hook
                (lambda ()
                  (double-saber-mode)
                  (setq-local double-saber-start-line 5)
                  (setq-local double-saber-end-text "Grep finished"))))

    (with-eval-after-load "ggtags"
      (add-hook 'ggtags-global-mode-hook
                (lambda ()
                  (double-saber-mode)
                  (setq-local double-saber-start-line 5)
                  (setq-local double-saber-end-text "Global found")))))

  (with-eval-after-load "ivy"
    (add-hook 'ivy-occur-grep-mode-hook
              (lambda ()
                (double-saber-mode)
                (setq-local double-saber-start-line 5))))
#+END_SRC
*** Copy/Pasted/Delete
Baseline configuration for copy/pasting, nothing fancy.

#+begin_src emacs-lisp
(setq mouse-drag-copy-region nil
      select-enable-primary nil
      select-enable-clipboard t
      select-active-regions t)
#+end_src

Hungry deletion
#+begin_src emacs-lisp
  (use-package hungry-delete
    :ensure t
    :diminish
    :init (setq hungry-delete-except-modes
              '(help-mode minibuffer-mode minibuffer-inactive-mode calc-mode))
    :hook (after-init . global-hungry-delete-mode)
    :config (setq-default hungry-delete-chars-to-skip " \t\f\v"))
#+end_src

*** Evil Nerd Commenter
Evil Nerd Commenter, a tool that helps you comment code efficiently.
#+BEGIN_SRC emacs-lisp
  (use-package evil-nerd-commenter
    :ensure t
    :bind
    (("C-c M-;" . c-toggle-comment-style)
     ("M-;" . evilnc-comment-or-uncomment-lines)))
#+END_SRC
*** expand region
#+begin_src emacs-lisp
  ;; Expand selected region by semantic units
  (use-package expand-region
    :ensure t
    :config
    (pending-delete-mode t)
     :bind ("C-=" . er/expand-region))
#+end_src

** recursive-edit
** fringe mode
The fringes are areas to the right and left side of an Emacs frame. They can be used to show status-related or contextual feedback
such as line truncation indicators, continuation lines, code linting markers, etc.

The default fringe width (*nil*) is 8 pixels on either side, which I approve of. It is possible to set the value of the *fringe-mode* to
something like *'(10 . 5)* which applies the varied width to the left and right side respectively.
Otherwise, we can use a single integer that controls both sides.

The use of *setq-default* is necessary, otherwise these values become buffer-local.
#+begin_src emacs-lisp
(use-package fringe
  :config
  (fringe-mode nil)
  (setq-default fringes-outside-margins nil)
  (setq-default indicate-buffer-boundaries nil)
  (setq-default indicate-empty-lines nil)
  (setq-default overflow-newline-into-fringe t))
#+end_src

* emacs capacity
** org
C-c C-, s : insert source block
M-x org-edit-src-code : edit source block
*** Global
#+begin_src emacs-lisp
  (use-package org
    :ensure org-plus-contrib
    :config
    (setq
         org-startup-indented t
         org-startup-folded t
         org-show-following-heading t
         org-show-hierarchy-above t
         org-show-siblings '((default))
         org-src-fontify-natively t
         org-src-tab-acts-natively t
         org-hide-emphasis-markers t))
#+end_src
*** Faces
#+begin_src emacs-lisp

#+end_src
*** Org-bullets
#+begin_src emacs-lisp
  (use-package org-bullets
    :ensure t
    :hook
    (org-mode . (lambda () (org-bullets-mode 1))))
#+end_src
*** Fancy priority
#+begin_src emacs-lisp
  (use-package org-fancy-priorities
    :ensure t
    :hook
    (org-agenda-mode . org-fancy-priorities-mode)
    (org-mode . org-fancy-priorities-mode)
    :config
    (setq org-fancy-priorities-list
          '((?A . "â—") (?B . "â¬†") (?C . "â¬‡") (?D . "â˜•")
            (?1 . "âš¡") (?2 . "â®¬") (?3 . "â®®") (?4 . "â˜•")
            (?I . "Important"))))
#+end_src

** which-key
#+BEGIN_SRC emacs-lisp
  ;; Display available keybindings in a popup
  (use-package which-key
    :ensure t
    :diminish
    :config
;;    ;;Manual Activation
;;    (setq which-key-show-early-on-C-h nil)
;;    (setq which-key-idle-delay most-positive-fixnum)
;;    (setq which-key-idle-secondary-delay 0.05)
    (setq which-key-idle-delay 0.5)
    (setq which-key-popup-type 'side-window)
    (setq which-key-show-prefix 'echo)
    (setq which-key-max-display-columns 4)
    (setq which-key-separator " â†’ " )
    (setq which-key-special-keys nil)
    (which-key-mode 1))
#+END_SRC
** multiple cursors
#+begin_src emacs-lisp
;; C-x r t string-rectangle
(use-package multiple-cursors
  :ensure t
  :bind (("C-S-c C-S-c"   . mc/edit-lines)
         ("C->"           . mc/mark-next-like-this)
         ("C-<"           . mc/mark-previous-like-this)
         ("C-c C-<"       . mc/mark-all-like-this)
         ("C-M->"         . mc/skip-to-next-like-this)
         ("C-M-<"         . mc/skip-to-previous-like-this)
         ("s-<mouse-1>"   . mc/add-cursor-on-click)
         ("C-S-<mouse-1>" . mc/add-cursor-on-click)
         :map mc/keymap
         ("C-|" . mc/vertical-align-with-space)))

;; Smartly select region, rectangle, multi cursors
;;(use-package smart-region
;;  :ensure t
;;  :hook (after-init . smart-region-on))

;; Edit multiple regions simultaneously in a buffer or a region
;;(use-package iedit
;;  :ensure t
;;  :config
;;  (delete-selection-mode t))
#+end_src

** Writing
*** Inspiration helpers
As I write papers, it is useful to have some helper to start to have the inspiration.
#+begin_src emacs-lisp
  (use-package academic-phrases
    :ensure t)

  (use-package mw-thesaurus
    :disabled t
    :quelpa
    (mw-thesaurus :fetcher github :repo "agzam/mw-thesaurus.el")
    :commands (mw-thesaurus-lookup-at-point))
#+end_src
*** Grammar checking
**** For english
#+begin_src emacs-lisp
  (use-package grammarly
    :ensure t)
#+end_src
*** Translation
**** WordReference
#+begin_src emacs-lisp
(use-package wordreference
  :load-path default-plugin-dir
  :commands (wordreference wordreference-at-point))
#+end_src
**** English Teacher
#+begin_src emacs-lisp
(use-package english-teacher
  :load-path "~/.emacs.d/third_parties/english-teacher.el"
  ;;:bind (("C-' C-l" . english-teacher-smart-translation))
  :config (setq english-teacher-backend 'baidu
                              english-teacher-show-result-function 'english-teacher-eldoc-show-result-function)
  :hook ((Info-mode-hook eww-mode-hook help-mode-hook) . english-teacher-follow-mode))
#+end_src
**** google translate
#+begin_src emacs-lisp
(add-to-list 'load-path "~/.emacs.d/third_parties/go-translate")
(require 'go-translate)
  (setq go-translate-base-url "https://translate.google.cn")
  (setq go-translate-local-language "zh-CN")

  (setq go-translate-buffer-follow-p t)       ; ç¿»è¯‘å®Œæˆåï¼Œæ€»æ˜¯å°†å…‰æ ‡åˆ‡æ¢åˆ°ç¿»è¯‘ç»“æœçª—å£
  (setq go-translate-buffer-source-fold-p t)  ; åœ¨ç»“æœé¡µé¢ï¼ŒæŠ˜å æºæ–‡æœ¬ã€‚å¯ä»¥é€šè¿‡å›è½¦æˆ–é¼ æ ‡ç‚¹å‡»å±•å¼€
;;  (setq go-translate-buffer-window-config ..) ; æ›´æ”¹ç¿»è¯‘çª—å£çš„ä½ç½®å’Œæ ·å¼

  ;; è®¾ç½®è¾“å…¥é£æ ¼ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯é€šè¿‡ Minibuffer æ–¹å¼è¡¥å…¨ç”¨æˆ·è¾“å…¥
  ;; å¯ä»¥ä¿®æ”¹ä¸º `go-translate-inputs-noprompt` æˆ– `go-translate-inputs-current-or-prompt`
  ;; å‰è€…è¡¨ç¤ºç›´æ¥ç¿»è¯‘é€‰ä¸­å†…å®¹æˆ–å…‰æ ‡ä¸‹å•è¯ï¼›åè€…è¡¨ç¤ºè‹¥å…‰æ ‡ä¸‹æ²¡å†…å®¹åˆ™æ‰“å¼€ Minibuffer è¯»å–å†…å®¹
  (setq go-translate-inputs-function #'go-translate-inputs-current-or-prompt)
#+end_src
** Language checking
*** Spelling
Configuration of the (fly) spelling for emacs. For spelling, I am using aspell.

#+begin_src shell :tangle no
sudo pacman -S aspell
#+end_src

#+begin_src emacs-lisp
    ;; Flyspell
    (use-package flyspell
      :ensure t
      :bind (:map flyspell-mode-map
      ;;          ("C-," . nil)
                ("C-;" . nil))
      :config
      ;; Some skipping
      (add-to-list 'ispell-skip-region-alist '("^#+begin_src" . "^#+end_src"))

      (setq flyspell-prog-text-faces '(font-lock-comment-face font-lock-doc-face))
      (add-hook 'prog-mode-hook 'flyspell-prog-mode)
      :diminish 'flyspell-mode)

    ;; Correct the misspelled word in a popup menu
    (use-package flyspell-popup
      :ensure t
      :config
      (define-key flyspell-mode-map (kbd "C-,") #'flyspell-popup-correct)
      (define-key popup-menu-keymap (kbd "C-j") 'popup-next)
      (define-key popup-menu-keymap (kbd "C-k") 'popup-previous)
      (define-key popup-menu-keymap (kbd "C-l") 'popup-select))
#+end_src
*** English checking
lang-tool is actually supported by emacs through a dedicated mode which allows to have syntax and
typography checking.

#+begin_src shell :tangle no
sudo pacman -S languagetool
#+end_src

To check current buffer and show warnings.
M-x langtool-check
To finish checking. All langtool marker is removed.
M-x langtool-check-done

#+BEGIN_SRC emacs-lisp :tangle no
(use-package langtool
  :disabled t
  :ensure quelpa
  :quelpa (langtool :fetcher github :repo "mhayashi1120/Emacs-langtool")
  :init
  (setq langtool-java-classpath
        "/usr/share/languagetool:/usr/share/java/languagetool/*"))
  ;;(setq langtool-language-tool-server-jar "~/work/tools/src/languagetool/languagetool/languagetool-server.jar"))
#+END_SRC
** Chinese input
#+BEGIN_SRC emacs-lisp
(use-package pyim
  :init
  (use-package posframe :defer t)
  :custom
  (default-input-method "pyim")
  (pyim-default-scheme 'quanpin)
  (pyim-page-tooltip 'posframe)
  (pyim-page-length 9)
  :config
  (pyim-isearch-mode 1)
  (setq-default pyim-english-input-switch-functions
                '(pyim-probe-isearch-mode
                  pyim-probe-org-structure-template))
  (setq-default pyim-punctuation-half-width-functions
                '(pyim-probe-punctuation-line-beginning
                  pyim-probe-punctuation-after-punctuation))
  :bind
  ("M-j" . pyim-convert-string-at-point)) ; M-j å¼ºåˆ¶å°†å…‰æ ‡å‰çš„æ‹¼éŸ³å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸­æ–‡ã€‚

(use-package pyim-basedict
  :after pyim
  :config (pyim-basedict-enable))
#+END_SRC


* format
** format-all
We can globally reformat the buffer relying on external tool. =format-all= is here for this.

#+begin_src emacs-lisp
  (use-package format-all
    :ensure t
    :commands (format-all-buffer format-all-mode))
  (setq clang-format-style-option "google")
#+end_src

** Indentation
#+begin_src emacs-lisp
  (use-package highlight-indent-guides
    :ensure t
    :commands (highlight-indent-guides-mode)
    :hook
    (prog-mode . highlight-indent-guides-mode)
    :config
    (setq highlight-indent-guides-method 'character));;fill, column, character, bitmap
#+end_src
* Manual
** manpage
#+begin_src emacs-lisp
  (use-package man
  :ensure nil
  :config
  (setq Man-notify-method 'aggressive))
#+end_src

** Helm dash
Offline documentation browser for +150 APIs using Dash docsets.
#+BEGIN_SRC emacs-lisp
(use-package helm-dash
  :ensure t)
#+END_SRC

* Syntax checking
#+begin_src emacs-lisp
  ;; Disable checking doc
  (use-package flycheck
    :ensure t
    :commands (flycheck-error-list-set-filter flycheck-next-error flycheck-previous-error flycheck-first-error)
    :hydra
    (hydra-flycheck (:pre (progn (setq hydra-hint-display-type t) (flycheck-list-errors))
                     :post (progn (setq hydra-hint-display-type nil) (quit-windows-on "*Flycheck errors*"))
                     :color teal :hint nil)
                    "Errors"
                    ("f"  flycheck-error-list-set-filter                            "Filter")
                    ("j"  flycheck-next-error                                       "Next")
                    ("k"  flycheck-previous-error                                   "Previous")
                    ("gg" flycheck-first-error                                      "First")
                    ("G"  (progn (goto-char (point-max)) (flycheck-previous-error)) "Last")
                    ("<" hydra-project/body "back")
                    ("q"   nil "cancel" :color blue))

    :config
    (setq-default flycheck-disabled-checkers '(emacs-lisp-checkdoc))

    (flycheck-define-checker proselint
      "A linter for prose."
      :command ("proselint" source-inplace)
      :error-patterns
      ((warning line-start (file-name) ":" line ":" column ": "
                (id (one-or-more (not (any " "))))
                (message) line-end))
      :modes (text-mode markdown-mode gfm-mode org-mode))
    )
#+end_src
* Templating
I use templates for 2 use cases: the buffer edition and the file specific templates. Both are relying on *yasnippet*.

** Edition templates
The default configuration of yasnippet consists of activating it and plugging it with company.
Ivy-yasnippet is used for snippet discovery.
#+BEGIN_SRC emacs-lisp
;; Yasnippet, a template system for emacs
  (use-package yasnippet
    :ensure t
    :config

    ;; Adding yasnippet support to company
    (eval-after-load 'company
      '(lambda ()
         (add-to-list 'company-backends 'company-yasnippet)))

    ;; Add third parties snippets
    (defvar third-parties-snippet-dir (format "%s/third_parties/snippets" user-emacs-directory)
      "Directory containing my own snippets")

    (defun third-parties-snippets-initialize ()
      (add-to-list 'yas-snippet-dirs 'third-parties-snippet-dir t)
      (yas-load-directory third-parties-snippet-dir t))

    (eval-after-load 'yasnippet '(third-parties-snippets-initialize))

    ;; Activate global
    (yas-global-mode))

  ;; Load official snippets
  (use-package yasnippet-snippets
    :ensure t)
  (use-package yasnippet-classic-snippets
    :ensure t)

  ;; Connect with ivy to have a list on demand
  (use-package ivy-yasnippet
    :ensure t)

#+END_SRC
** Filetype templates
This part is using yatemplate (an over-layer of yasnippet) coupled with auto-insert to have a set of
file type dedicated templates. The templates are available in =third_parties/templates= directory.

To put some predefined text at the beginning of the buffer.
M-x *auto-insert*

#+begin_src emacs-lisp
  (use-package yatemplate
    :ensure t
    :after yasnippet
    :config

    ;; Define template directory
    (setq yatemplate-dir (concat user-emacs-directory "/third_parties/templates"))

    ;; Coupling with auto-insert
    (setq auto-insert-alist nil)
    (yatemplate-fill-alist)
    ;; (add-hook 'find-file-hook 'auto-insert)
    )
#+end_src


* Completion
This part focuses on completion configuration. Language specific configurations are not done here
but in the dedicate language configuration part. This section is just for global configuration.
** Compdef
compdef sets backends as a local variable for that specific mode.
#+begin_src emacs-lisp
;;(use-package compdef :ensure t)
#+end_src
** embark
#+begin_src emacs-lisp
(use-package marginalia
  :ensure t
  :config
  (marginalia-mode))

(use-package embark
  :ensure t
  :bind
  (("C-." . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

  :init
  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :config
  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

;; Consult users will also want the embark-consult package.
(use-package embark-consult
  :ensure t
  :after (embark consult)
  :demand t ; only necessary if you have the hook below
  ;; if you want to have consult previews as you move around an
  ;; auto-updating embark collect buffer
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src
** Ivy/swipper/counsel
I do prefer vertical completion, which is why I use extensively Ivy and extensions.
#+begin_src emacs-lisp :tangle no
(ivy-mode)
(setq ivy-use-virtual-buffers t)
(setq enable-recursive-minibuffers t)
;; enable this if you want `swiper' to use it
;; (setq search-default-mode #'char-fold-to-regexp)
(global-set-key "\C-s" 'swiper)
(global-set-key (kbd "C-c C-r") 'ivy-resume)
(global-set-key (kbd "<f6>") 'ivy-resume)
(global-set-key (kbd "M-x") 'counsel-M-x)
(global-set-key (kbd "C-x C-f") 'counsel-find-file)
(global-set-key (kbd "C-h f") 'counsel-describe-function)
(global-set-key (kbd "C-h v") 'counsel-describe-variable)
(global-set-key (kbd "C-h o") 'counsel-describe-symbol)
(global-set-key (kbd "<f1> l") 'counsel-find-library)
(global-set-key (kbd "<f2> i") 'counsel-info-lookup-symbol)
(global-set-key (kbd "<f2> u") 'counsel-unicode-char)
(global-set-key (kbd "C-c g") 'counsel-git)
(global-set-key (kbd "C-c j") 'counsel-git-grep)
(global-set-key (kbd "C-c k") 'counsel-ag)
(global-set-key (kbd "C-x l") 'counsel-locate)
(global-set-key (kbd "C-S-o") 'counsel-rhythmbox)
(define-key minibuffer-local-map (kbd "C-r") 'counsel-minibuffer-history)
#+end_src
#+begin_src emacs-lisp
  ;; Generic completion frontend
  (use-package counsel
    :ensure t
    :bind
    (("M-x" . counsel-M-x)
     ("M-y" . counsel-yank-pop)
     :map ivy-minibuffer-map
     ("M-y" . ivy-next-line)))
  (define-key minibuffer-local-map (kbd "C-r") 'counsel-minibuffer-history)
  ;; Enhance M-x
  (use-package amx
    :ensure t
    :init (setq amx-history-length 20))

  (global-set-key (kbd "C-x C-f") #'counsel-find-file)
  (global-set-key (kbd "C-c r") #'counsel-recentf)

  (use-package flx :ensure t)
  (use-package ivy-hydra :ensure t)
  (use-package ivy
    :ensure t
    :diminish 'ivy-mode
    :config
    (ivy-mode t)
    (setq ivy-display-style 'fancy
          ivy-use-virtual-buffers t
          enable-recursive-minibuffers t
          ivy-use-selectable-prompt t)
    ;; make everything fuzzy except swiper
    (setq ivy-re-builders-alist
          '((swiper . ivy--regex-plus)
            (t . ivy--regex-fuzzy))))

  (global-set-key (kbd "C-r") #'swiper)
  (global-set-key (kbd "C-s") #'swiper)

  (use-package ivy-rich
    :ensure t
    :config
    (ivy-rich-mode 1)
    (setcdr (assq t ivy-format-functions-alist) #'ivy-format-function-line))

  ;; Show ivy frame using posframe
  (use-package ivy-posframe
    :ensure t
    :custom
    (ivy-display-function #'ivy-posframe-display-at-frame-center)
    ;; (ivy-posframe-width 130)
    ;; (ivy-posframe-height 11)
    (ivy-posframe-parameters
      '((left-fringe . 5)
        (right-fringe . 5)))
    :custom-face
    (ivy-posframe ((t (:background "#282a36"))))
    (ivy-posframe-border ((t (:background "#6272a4"))))
    (ivy-posframe-cursor ((t (:background "#61bfff"))))
    :hook
    (ivy-mode . ivy-posframe-enable))
#+end_src
** Helm
I use Helm for some specific cases which requires an important visibility space completion.

#+begin_src emacs-lisp
  (use-package helm
    :ensure t
    :functions helm-show-completion-default-display-function
    :config
    (setq helm-scroll-amount 4 ; scroll 4 lines other window using M-<next>/M-<prior>
          helm-quick-update t ; do not display invisible candidates
          helm-idle-delay 0.01 ; be idle for this many seconds, before updating in delayed sources.
          helm-input-idle-delay 0.01 ; be idle for this many seconds, before updating candidate buffer
          helm-show-completion-display-function #'helm-show-completion-default-display-function
          helm-split-window-default-side 'below ;; open helm buffer in another window
          helm-split-window-inside-p t ;; open helm buffer inside current window, not occupy whole other window
          helm-candidate-number-limit 200 ; limit the number of displayed canidates
          helm-move-to-line-cycle-in-source nil ; move to end or beginning of source when reaching top or bottom of source.
          )
    )
#+end_src
** Company
In order to have inline completion, really important for coding, I use company. However I adapted
some facing attributes. Each language is also adding its backend when needed. Therefore, only global
configuration here.

#+begin_src emacs-lisp
;; Company mode
;;  (use-package company
;;    :diminish 'company-mode
;;    :config
;;    (setq company-tooltip-align-annotations t)
;;    (add-hook 'after-init-hook 'global-company-mode))

(use-package company
  :ensure t
  :hook
  (emacs-lisp-mode . (lambda () (add-to-list (make-local-variable 'company-backends) '(company-elisp))))
  :config

  ;; Global
  (setq company-idle-delay 1
        company-minimum-prefix-length 1
        company-idle-delay 0.0 ;;dafault is 0.2
        company-show-numbers t
        company-tooltip-limit 20)

  ;; using child frame
  (use-package company-posframe
    :ensure t
    :hook (company-mode . company-posframe-mode))

  ;; Facing
  (unless (face-attribute 'company-tooltip :background)
    (set-face-attribute 'company-tooltip nil :background "black" :foreground "gray40")
    (set-face-attribute 'company-tooltip-selection nil :inherit 'company-tooltip :background "gray15")
    (set-face-attribute 'company-preview nil :background "black")
    (set-face-attribute 'company-preview-common nil :inherit 'company-preview :foreground "gray40")
    (set-face-attribute 'company-scrollbar-bg nil :inherit 'company-tooltip :background "gray20")
    (set-face-attribute 'company-scrollbar-fg nil :background "gray40"))

  ;; Default backends
  (setq company-backends '(company-capf company-files))

  ;; Activating globally
  (global-company-mode t))

(use-package company-quickhelp
  :ensure t
  :after company
  :config
  (company-quickhelp-mode 1))

;; A company front-end with icons
(use-package company-box
  :ensure t
  :hook (company-mode . company-box-mode))
#+end_src

** Prescient
Prescient helps to sort candidates by last used first and then sorting by length.

#+begin_src emacs-lisp
  (use-package prescient
    :ensure t
    :config (prescient-persist-mode))
  ;;Disabled for now because it seems to be [[broken and unmaintained][https://github.com/raxod502/prescient.el/issues/65]] (as of [2020-09-06 Sun]).
  (use-package ivy-prescient
    :disabled
    :ensure t
    :config (ivy-prescient-mode))

  (use-package company-prescient
    :ensure t
    :config (company-prescient-mode))
#+end_src
** eldoc
#+begin_src emacs-lisp
  ;; Show the argument list of a function in the echo area
(use-package eldoc
  :diminish eldoc-mode
  :commands turn-on-eldoc-mode
  :defer t)
#+end_src

* Compilation
** compilation
#+begin_src emacs-lisp
  (use-package compile
    :defer
    :diminish compilation-in-progress
    :init
    (setq compilation-scroll-output t)
    :config
    (setq compilation-always-kill t)
    (setq compilation-ask-about-save nil)
    (setq compilation-scroll-output 'first-error)
    )
#+end_src

** Keybinding
#+begin_src emacs-lisp
  (defhydra hydra-next-error (global-map "C-x")
      "
  Compilation errors:
  _j_: next error        _h_: first error    _q_uit
  _k_: previous error    _l_: last error
  "
      ("`" next-error     nil)
      ("j" next-error     nil :bind nil)
      ("k" previous-error nil :bind nil)
      ("h" first-error    nil :bind nil)
      ("l" (condition-case err
               (while t
                 (next-error))
             (user-error nil))
       nil :bind nil)
      ("q" nil            nil :color blue))
#+end_src

* Project management
** Configuration projectile
The commands are based on http://endlessparentheses.com/improving-projectile-with-extra-commands.html?source=rss
#+BEGIN_SRC emacs-lisp
;; ripgrep
(use-package rg
  :ensure t)

;; A project interaction library
(use-package projectile
  :ensure t
  :after (rg)
  :config
  (setq projectile-project-search-path '("~/dev"))
  (add-to-list 'projectile-globally-ignored-directories "node_modules")
  (projectile-global-mode)
  :init
  (setq projectile-cache-file (concat user-emacs-directory ".cache/projectile.cache")
        projectile-known-projects-file (concat user-emacs-directory
                                               ".cache/projectile-bookmarks.eld"))
  (add-hook 'find-file-hook (lambda ()
                              (unless recentf-mode (recentf-mode)
                                      (recentf-track-opened-file))))
  :bind-keymap
  ("C-c p" . projectile-command-map)
  :bind
  (:map projectile-mode-map ("C-c p s p" . rg-project))
  :diminish 'projectile-mode)
#+END_SRC
** Completion
#+BEGIN_SRC emacs-lisp
    (use-package counsel-projectile
      :ensure t
      :after projectile
      :functions
      (counsel-projectile-find-file-in-directory
       counsel-projectile-ibuffer
       counsel-projectile-kill-buffers
       counsel-projectile-multi-occur
       counsel-projectile-recentf
       counsel-projectile-remove-known-project
       counsel-projectile-cleanup-known-projects
       counsel-projectile-cache-current-file
       counsel-projectile-invalidate-cache
       ggtags-update-tags ;; FIXME: a require should be put somewhere maybe
       )

      :hydra
      (hydra-projectile (:color teal :hint nil)
                        "
           PROJECTILE: %(projectile-project-root)

           Find File            Search/Tags          Buffers                Cache
      ------------------------------------------------------------------------------------------
      _s-f_: file            _a_: ag                _i_: Ibuffer           _c_: cache clear
       _ff_: file dwim       _g_: update gtags      _b_: switch to buffer  _x_: remove known project
       _fd_: file curr dir   _o_: multi-occur     _s-k_: Kill all buffers  _X_: cleanup non-existing
        _r_: recent file                                               ^^^^_z_: cache current
        _d_: dir

      "
                        ("<ESC>" nil "quit")
                        ("<" hydra-project/body "back")
                        ("a"   counsel-projectile-ag)
                        ("b"   counsel-projectile-switch-to-buffer)
                        ("c"   counsel-projectile-invalidate-cache)
                        ("d"   counsel-projectile-find-dir)
                        ("s-f" counsel-projectile-find-file)
                        ("ff"  counsel-projectile-find-file-dwim)
                        ("fd"  counsel-projectile-find-file-in-directory)
                        ("g"   ggtags-update-tags)
                        ("s-g" ggtags-update-tags)
                        ("i"   counsel-projectile-ibuffer)
                        ("K"   counsel-projectile-kill-buffers)
                        ("s-k" counsel-projectile-kill-buffers)
                        ("m"   counsel-projectile-multi-occur)
                        ("o"   counsel-projectile-multi-occur)
                        ("s-p" counsel-projectile-switch-project "switch project")
                        ("p"   counsel-projectile-switch-project)
                        ("s"   counsel-projectile-switch-project)
                        ("r"   counsel-projectile-recentf)
                        ("x"   counsel-projectile-remove-known-project)
                        ("X"   counsel-projectile-cleanup-known-projects)
                        ("z"   counsel-projectile-cache-current-file)
                        ("q"   nil "cancel" :color blue)))
  ;;(use-package counsel-projectile
  ;;  :config
  ;;  (counsel-projectile-mode t)
  ;;  (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map))
#+END_SRC
* Version management
** magit
#+BEGIN_SRC emacs-lisp
;; A git interface for emacs
(use-package magit
  :config
  (setq magit-refresh-status-buffer nil)
  :diminish 'auto-revert-mode
  :defer t)

(global-set-key (kbd "C-x g") #'magit-status)
(global-set-key (kbd "C-x M-g") #'magit-dispatch)

;; Show diffs in the gutter
(use-package diff-hl
  :config
  (add-hook 'magit-post-refresh-hook 'diff-hl-magit-post-refresh)
  (global-diff-hl-mode t)
  (diff-hl-flydiff-mode t))
#+END_SRC
** Keybinding
#+begin_src emacs-lisp
  (defhydra hydra-project (:color teal :hint nil)
    "
         Project/Source management

     Projects              Version control        On-the-fly
    ------------------------------------------------------------------------------------------
    _d_: dash projects     _m_: magit             _f_: fixme listing
    _p_: projectile        _t_: travis status     _F_: flycheck

    "
    ("<ESC>" nil "quit")
    ("d"   org-dashboard-display)
    ("p"   hydra-projectile/body)
    ("f"   fic-view-listing)
    ("F"   hydra-flycheck/body)
    ("m"   hydra-magit/body)
    ("t"   show-my-travis-projects)
    ("q"   nil "cancel" :color blue))
  (global-set-key (kbd "<f4>") 'hydra-project/body)
#+end_src
* File/Dir management
** Diff
*** Global
#+begin_src emacs-lisp
  (use-package ediff
    :config
    (autoload 'diff-mode "diff-mode" "Diff major mode" t)
    (setq diff-switches "-u"
          ediff-auto-refine-limit (* 2 14000)
          ediff-window-setup-function 'ediff-setup-windows-plain
          ediff-split-window-function
          (lambda (&optional arg)
            (if (> (frame-width) 160)
                (split-window-horizontally arg)
              (split-window-vertically arg)))))
#+end_src
*** Helpers for region diff
#+begin_src emacs-lisp
  (defun diff-region ()
    "Select a region to compare"
    (interactive)
    (when (use-region-p) ; there is a region
      (let (buf)
        (setq buf (get-buffer-create "*Diff-regionA*"))
        (save-current-buffer
          (set-buffer buf)
          (erase-buffer))
        (append-to-buffer buf (region-beginning) (region-end)))
      )
    (message "Now select other region to compare and run `diff-region-now`"))

  (defun diff-region-now ()
    "Compare current region with region already selected by `diff-region`"
    (interactive)
    (when (use-region-p)
      (let (bufa bufb)
        (setq bufa (get-buffer-create "*Diff-regionA*"))
        (setq bufb (get-buffer-create "*Diff-regionB*"))
        (save-current-buffer
          (set-buffer bufb)
          (erase-buffer))
        (append-to-buffer bufb (region-beginning) (region-end))
        (ediff-buffers bufa bufb))
      ))
#+end_src
** Trash
#+begin_src emacs-lisp
  ;; Ask confirmation only once and move to trash
  (setq dired-recursive-deletes 'always)
  (setq delete-by-moving-to-trash t)

  (defun empty-trash()
    "Command to empty the trash (for now gnome/linux specific)"
    (interactive)
    (shell-command "rm -rf ~/.local/share/Trash/*"))

  (defun open-trash-dir()
    "Command to open the trash dir"
    (interactive)
    (find-file "~/.local/share/Trash/files"))
#+end_src
** Treemacs
*** Global
#+begin_src emacs-lisp
  (use-package treemacs
    :ensure t
    :bind (:map global-map
                ([f8]        . treemacs))
    :functions (treemacs-follow-mode treemacs-filewatch-mode)

    :config
    (setq treemacs-collapse-dirs                 (if treemacs-python-executable 3 0)
          treemacs-deferred-git-apply-delay      0.5
          treemacs-display-in-side-window        t
          treemacs-eldoc-display                 t
          treemacs-file-event-delay              5000
          treemacs-file-follow-delay             0.2
          treemacs-follow-after-init             t
          treemacs-git-integration               t
          treemacs-git-command-pipe              ""
          treemacs-goto-tag-strategy             'refetch-index
;;          treemacs-indentation                   2
          treemacs-indentation-string            " "
          treemacs-is-never-other-window         nil
          treemacs-max-git-entries               5000
          treemacs-missing-project-action        'ask
          treemacs-no-png-images                 nil
          treemacs-no-delete-other-windows       t
          treemacs-project-follow-cleanup        nil
          treemacs-persist-file                  (expand-file-name ".cache/treemacs-persist" user-emacs-directory)
          treemacs-position                      'left
          treemacs-recenter-distance             0.1
          treemacs-recenter-after-file-follow    nil
          treemacs-recenter-after-tag-follow     nil
          treemacs-recenter-after-project-jump   'always
          treemacs-recenter-after-project-expand 'on-distance
          treemacs-show-cursor                   nil
          treemacs-show-hidden-files             t
          treemacs-silent-filewatch              nil
          treemacs-silent-refresh                nil
          treemacs-sorting                       'alphabetic-desc
          treemacs-space-between-root-nodes      t
          treemacs-tag-follow-cleanup            t
          treemacs-tag-follow-delay              1.5
          treemacs-width                         35)

    (treemacs-follow-mode t)
    (treemacs-filewatch-mode t))
#+end_src
*** Projectile
#+begin_src emacs-lisp
  (use-package treemacs-projectile
    :ensure t
    :functions treemacs-projectile-create-header
    :after treemacs projectile
    :config
    (setq treemacs-header-function #'treemacs-projectile-create-header))
#+end_src
*** Magit
#+begin_src emacs-lisp
  (use-package treemacs-magit
    :after treemacs magit
    :ensure t)
#+end_src
*** Icons
#+begin_src emacs-lisp
(use-package treemacs-icons-dired
  :after treemacs dired
  :ensure t
  :config (treemacs-icons-dired-mode))
(use-package treemacs-icons-dired
  :ensure t
  :disabled t
  :commands (treemacs-icons-dired-mode)
  :hook
  (dired-mode . treemacs-icons-dired--enable-highlight-correction)
  (dired-mode . treemacs--select-icon-set )
  (dired-mode . treemacs-icons-dired-mode))
#+end_src


* Custom Functions
** Change letter case
#+begin_src emacs-lisp
(defun upcase-backward-word (arg)
  (interactive "p")
  (upcase-word (- arg)))

(defun downcase-backward-word (arg)
  (interactive "p")
  (downcase-word (- arg)))

(defun capitalize-backward-word (arg)
  (interactive "p")
  (capitalize-word (- arg)))
#+end_src
* Custom Keybinding
** personal
#+BEGIN_SRC emacs-lisp
;; Unbind unneeded keys
(global-set-key (kbd "C-z") nil)
(global-set-key (kbd "M-z") nil)
(global-set-key (kbd "C-x C-z") nil)
(global-set-key (kbd "M-/") nil)
(global-set-key (kbd "C-x C-b") #'ibuffer)
(global-set-key (kbd "C-x C-e") #'pp-eval-last-sexp)

(global-set-key (kbd "M-i") #'imenu)

(global-set-key (kbd "C-x k") 'kill-this-buffer)

(use-package helm-descbinds
  :ensure t
  :commands (helm-descbinds)
  :bind
  ("C-h b" . helm-descbinds))

;;opening new lines can be finichy
(defun open-line-below()
    "open line below."
    (interactive)
    (end-of-line)
    (newline)
    (indent-for-tab-command))
(defun open-line-above()
    "open line above."
    (interactive)
    (beginning-of-line)
    (newline)
    (forword-line -1)
    (indent-for-tab-command))
(global-set-key (kbd "<C-return>") 'open-line-below)
(global-set-key (kbd "<C-S-return>") 'open-line-above)

(defun scroll-half-page-down ()
  "scroll down half the page"
  (interactive)
  (scroll-down (/ (window-body-height) 2)))

(defun scroll-half-page-up ()
  "scroll up half the page"
  (interactive)
  (scroll-up (/ (window-body-height) 2)))

(global-set-key "\M-n" 'scroll-half-page-up)
(global-set-key "\M-p" 'scroll-half-page-down)

(global-set-key (kbd "C-S-n")
                (lambda()
                  (interactive)
                  (ignore-errors (next-line 5))))
(global-set-key (kbd "C-S-p")
                (lambda()
                  (interactive)
                  (ignore-errors (previous-line 5))))
(global-set-key (kbd "C-S-f")
                (lambda()
                  (interactive)
                  (ignore-errors (forword-char 5))))
(global-set-key (kbd "C-S-b")
                (lambda()
                  (interactive)
                  (ignore-errors (backward-char 5))))
;;
;; Copy or Cut one line if no content selected
;;
;; copy region or whole line
(global-set-key "\M-w"
(lambda ()
  (interactive)
  (if mark-active
      (kill-ring-save (region-beginning)
      (region-end))
    (progn
     (kill-ring-save (line-beginning-position)
     (line-end-position))
     (message "copied line")))))

;; kill region or whole line
(global-set-key "\C-w"
(lambda ()
  (interactive)
  (if mark-active
      (kill-region (region-beginning)
   (region-end))
    (progn
     (kill-region (line-beginning-position)
  (line-end-position))
     (message "killed line")))))

#+END_SRC
** go to last change
I could not find any built-in method of reliably moving back to the
  last change.  Using the mark ring is always an option, but does not fill
  the exact same niche.
The C-z binding is disabled elsewhere in this document.  It minimises
  the Emacs GUI by default.  A complete waste of an extremely valuable key
  binding!
#+begin_src emacs-lisp
(use-package goto-last-change
  :ensure
  :bind ("C-z" . goto-last-change))
#+end_src
** Reminder for bindings
#+begin_src emacs-lisp
(use-package remind-bindings
  :ensure t
  :init  (setq remind-bindings-initfile (format "%s/settings.el" user-emacs-directory))
  :hook (after-init . remind-bindings-initialise)
  :bind (("<f10>" . 'remind-bindings-togglebuffer)   ;; toggle buffer
         ("C-<f10>" . 'remind-bindings-specific-mode))) ;; buffer-specific only
#+end_src


* Language Server
** lsp
#+begin_src emacs-lisp
(use-package lsp-mode
  :ensure t
  :init
  ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
  (setq lsp-keymap-prefix "C-c l")
  :custom
  ;; clangd is fast
  (lsp-idle-delay 0.1)
  ;; be more ide-ish
  (lsp-modeline-code-actions-mode t)
  ;;é¢åŒ…å±‘å¯¼èˆª
  (lsp-headerline-breadcrumb-enable nil)
  ;; enable log only for debug
  (lsp-log-io nil)
  ;; handle yasnippet by myself
  (lsp-enable-snippet nil)
  ;; turn off for better performance
  (lsp-enable-symbol-highlighting t)
  ;; use `company-ctags' only.
  ;; Please note `company-lsp' is automatically enabled if installed
  (lsp-enable-completion-at-point t)
  ;; auto restart lsp
  (lsp-restart 'auto-restart)

  :hook (;; replace XXX-mode with concrete major-mode(e. g. python-mode)
         (c++-mode . lsp)
         (c-mode . lsp)
         ;; if you want which-key integration
         (lsp-mode . lsp-enable-which-key-integration))
  :commands lsp)
#+end_src
** lsp-ui
#+begin_src emacs-lisp
;; optionally
;; LSP UI tools
(use-package lsp-ui
  :ensure t
  :custom
  ;; lsp-ui-doc
  (lsp-ui-doc-enable nil)
  (lsp-ui-doc-header t)
  (lsp-ui-doc-include-signature nil)
  (lsp-ui-doc-position 'top) ;; top, bottom, or at-point
  (lsp-ui-doc-max-width 120)
  (lsp-ui-doc-max-height 30)
  (lsp-ui-doc-use-childframe t)
  (lsp-ui-doc-use-webkit t)
  ;; lsp-ui-flycheck
  (lsp-ui-flycheck-enable nil)
  ;; lsp-ui-sideline
  (lsp-ui-sideline-enable nil)
  (lsp-ui-sideline-ignore-duplicate t)
  (lsp-ui-sideline-show-symbol t)
  (lsp-ui-sideline-show-hover t)
  (lsp-ui-sideline-show-diagnostics nil)
  (lsp-ui-sideline-show-code-actions t)
  (lsp-ui-sideline-code-actions-prefix "ï€")
  ;; lsp-ui-imenu
  (lsp-ui-imenu-enable t)
  (lsp-ui-imenu-kind-position 'top)
  ;; lsp-ui-peek
  (lsp-ui-peek-enable t)
  (lsp-ui-peek-peek-height 20)
  (lsp-ui-peek-list-width 50)
  (lsp-ui-peek-fontify 'on-demand) ;; never, on-demand, or always
  :preface
  (defun my/toggle-lsp-ui-doc ()
    (interactive)
    (if lsp-ui-doc-mode
        (progn
          (lsp-ui-doc-mode -1)
          (lsp-ui-doc--hide-frame))
      (lsp-ui-doc-mode 1)))
  :bind
  (:map lsp-mode-map
        ("C-c C-r" . lsp-ui-peek-find-references)
        ("C-c C-j" . lsp-ui-peek-find-definitions)
        ("C-c i"   . lsp-ui-peek-find-implementation)
        ("C-c m"   . lsp-ui-imenu)
        ("C-c s"   . lsp-ui-sideline-mode)
        ("C-c d"   . my/toggle-lsp-ui-doc))
  :hook
  (lsp-mode . lsp-ui-mode))

;; if you are ivy user
(use-package lsp-ivy :ensure t :commands lsp-ivy-workspace-symbol)
(use-package lsp-treemacs :ensure t :commands lsp-treemacs-errors-list)

(use-package posframe :ensure t)
#+end_src
** citre
#+begin_src emacs-lisp :tangle no
  (use-package citre
    :ensure t
    :defer t
    :init
    ;; This is needed in `:init' block for lazy load to work.
    (require 'citre-config)
    ;; Bind your frequently used commands.
    (global-set-key (kbd "M-.") 'citre-jump)
    (global-set-key (kbd "M-,") 'citre-jump-back)
    (global-set-key (kbd "C-x c p") 'citre-ace-peek)
    :config
    (setq
     ;; Set this if readtags is not in your path.
     ;;citre-readtags-program "/path/to/readtags"
     ;; Set this if you use project management plugin like projectile.  It's
     ;; only used to display paths relatively, and doesn't affect actual use.
     citre-project-root-function #'projectile-project-root))
#+end_src
* Language cpp
#+begin_src shell :tangle no
sudo pacman -S global
#+end_src

#+BEGIN_SRC emacs-lisp
;; C/C++ Mode
(use-package cc-mode
  :ensure nil
  :bind (:map c-mode-base-map
              ("C-c c" . compile))
  :hook (c-mode-common . (lambda ()
                           (c-set-style "linux")
                           (setq tab-width 4)
                           (setq c-basic-offset 4))))

(use-package modern-cpp-font-lock
  :ensure t
  :diminish
  :init (modern-c++-font-lock-global-mode t))

;; counsel-etags for code navigation
(use-package counsel-etags
  :ensure t
  :bind (("C-]" . counsel-etags-find-tag-at-point))
  :init
  (add-hook 'prog-mode-hook
            (lambda ()
              (add-hook 'after-save-hook
                        'counsel-etags-virtual-update-tags 'append 'local)))
  :config
  (setq counsel-etags-update-interval 60)
  (push "build" counsel-etags-ignore-directories))

;;company-ctags for code completion
;;usage: find . -name "*.[ch]" | ctags -e -L -
(use-package company-ctags  ;; LSP server: (lsp-enable-completion-at-point t)
  :disabled t
  :ensure t
  :after company
  :config
  (company-ctags-auto-setup))

;; Emacs frontend to GNU GLobal source code tagging system
(use-package ggtags
  :ensure t
  :init
  (ggtags-mode 1)
  (add-hook 'c-mode-common-hook
            (lambda ()
              (when (derived-mode-p 'c-mode 'c++-mode 'java-mode 'asm-mode)
                (ggtags-mode 1))))
  :config
  (dolist (map (list ggtags-mode-map dired-mode-map))
    (define-key map (kbd "C-c g s") 'ggtags-find-other-symbol)
    (define-key map (kbd "C-c g h") 'ggtags-view-tag-history)
    (define-key map (kbd "C-c g r") 'ggtags-find-reference)
    (define-key map (kbd "C-c g f") 'ggtags-find-file)
    (define-key map (kbd "C-c g c") 'ggtags-create-tags)
    (define-key map (kbd "C-c g u") 'ggtags-update-tags)
    (define-key map (kbd "C-c g a") 'helm-gtags-tags-in-this-function)
    (define-key map (kbd "M-.") 'ggtags-find-tag-dwim)
    (define-key map (kbd "M-,") 'pop-tag-mark)
    (define-key map (kbd "C-c <") 'ggtags-prev-mark)
    (define-key map (kbd "C-c >") 'ggtags-next-mark)))

;; sudo pacman -S ccls
;; C/C++/Objective-C support
;;   (use-package ccls
;;     :defines projectile-project-root-files-top-down-recurring
;;     :hook ((c-mode c++-mode objc-mode cuda-mode) . (lambda ()
;;                                                      (require 'ccls)
;;                                                      (lsp-deferred)))
;;     :config
;;     (with-eval-after-load 'projectile
;;       (setq projectile-project-root-files-top-down-recurring
;;             (append '("compile_commands.json"
;;                       ".ccls")
;;                     projectile-project-root-files-top-down-recurring))))
#+END_SRC

* Language elisp
#+BEGIN_SRC emacs-lisp
;; String manipulation routines for emacs lisp
(use-package s
  :ensure t)

;; Minor mode for performing structured editing of S-expression data
(use-package paredit
  :disabled t
  :init
  (add-hook 'emacs-lisp-mode-hook       #'enable-paredit-mode)
  (add-hook 'eval-expression-minibuffer-setup-hook #'enable-paredit-mode)
  (add-hook 'ielm-mode-hook             #'enable-paredit-mode)
  (add-hook 'lisp-mode-hook             #'enable-paredit-mode)
  (add-hook 'lisp-interaction-mode-hook #'enable-paredit-mode)
  (add-hook 'scheme-mode-hook           #'enable-paredit-mode)
  :bind (("C-c d" . paredit-forward-down))
  :config
  (eldoc-add-command
   'paredit-backward-delete
   'paredit-close-round))

;; Ensure paredit is used EVERYWHERE!
(use-package paredit-everywhere
  :disabled t
  :ensure t
  :diminish paredit-everywhere-mode
  :config
  (add-hook 'list-mode-hook #'paredit-everywhere-mode))
#+END_SRC

* Language scheme
#+BEGIN_SRC emacs-lisp
  (use-package geiser
    :ensure t
    :config
    (setq geiser-active-implementations '(mit guile)))
#+END_SRC

* Language markdown
#+begin_src shell :tangle no
sudo pacman -S pandoc
sudo pop install grip
#+end_src

ç¼–è¯‘å’Œç»´æŠ¤å‘½ä»¤ C-c C-c
æ ·å¼: C-c C-s
è¶…é“¾æ¥: C-c C-a

** Global
#+begin_src emacs-lisp
;; Major mode for editing Markdown formatted text
(use-package markdown-mode
  :ensure t
  :defer t
  :commands (markdown-mode gfm-mode)
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.md\\'" . markdown-mode)
         ("\\.markdown\\'" . markdown-mode))
  :init (setq markdown-command "/usr/bin/pandoc"))

(use-package markdown-mode+
  :disabled t
  :ensure t
  :after markdown-mode)
#+end_src
** Syntax highlight in block
#+begin_src emacs-lisp
(use-package poly-markdown
  :ensure t
  :disabled t)
#+end_src
** Visualize GFM rendering
C-c C-c g
#+begin_src emacs-lisp
(use-package grip-mode
  :ensure t
  :commands (grip-mode)
  :bind (:map markdown-mode-command-map
         ("g" . grip-mode)))
#+end_src

* Language python
#+begin_src shell :tangle no
  sudo pip install 'python-language-server[all]'
#+end_src
** Global configuration
#+begin_src emacs-lisp
(use-package python
  :mode
  ("\\.py\\'" . python-mode)
  ("\\.wsgi$" . python-mode)

  :init
  (setq-default indent-tabs-mode nil)

  :config
  (setq python-indent-offset 4))
#+end_src
** Lsp (with microsoft language server)
#+BEGIN_SRC emacs-lisp :tangle no
(use-package lsp-python-ms
  :ensure t
  :demand
  :hook (python-mode . lsp-deferred)  ; or lsp-deferred
  :init
  (setq lsp-python-ms-dir "/usr/lib"
        lsp-python-ms-executable "/usr/bin/pyls")) ; mspyls ?
;;(use-package lsp-pyright
;;  :ensure t
;;  :after lsp-mode
;;  :hook (python-mode . (lambda ()
;;                         (require 'lsp-pyright)
;;                         (lsp)))
;;  :init
;;  (when (executable-find "python3")
;;    (setq lsp-pyright-python-executable-cmd "python3")))  ; or lsp-deferred
#+END_SRC
** Pipenv
#+begin_src emacs-lisp :tangle no
(use-package pipenv
  :ensure t
  :hook
  ((python-mode . pipenv-mode))

  :init
  (setq pipenv-projectile-after-switch-function
        #'pipenv-projectile-after-switch-extended))
#+end_src
** Conda
#+begin_src emacs-lisp :tangle no
(use-package conda
  :ensure t
  :init
  (setq conda-anaconda-home (expand-file-name "~/environment/local/miniconda3"))

  (defun conda-hook ()
    "Conda activation hook for python mode."
    (setq conda-message-on-environment-switch nil)
    (conda-env-autoactivate-mode t))

  :hook
  (python-mode . conda-hook)

  :config
  ;; If you want interactive shell support, include:
  (conda-env-initialize-interactive-shells)

  ;; If you want eshell support, include:
  (conda-env-initialize-eshell))
#+end_src
** Interpreter configuration
#+begin_src emacs-lisp :tangle no
(use-package ein
  :ensure t
  :config

  (cond
   ((eq system-type 'darwin) (setq ein:console-args '("--gui=osx" "--matplotlib=osx" "--colors=Linux")))
   ((eq system-type 'gnu/linux) (setq ein:console-args '("--gui=gtk3" "--matplotlib=gtk3" "--colors=Linux"))))

  (setq ein:query-timeout 1000))
#+end_src
** Sphinx documentation
#+begin_src emacs-lisp
(use-package sphinx-doc
  :ensure t
  :hook
  (python-mode . (lambda () (sphinx-doc-mode t))))
#+end_src
** Elpy
#+BEGIN_SRC emacs-lisp
;;(use-package elpy
;;  :init
;;  (elpy-enable))
#+END_SRC

* Language go
Go code helpers. [[https://tleyden.github.io/blog/2014/05/22/configure-emacs-as-a-go-editor-from-scratch/][see also]]

#+begin_src shell :tangle no
sudo pacman -S go
# plugin
go get -u github.com/nsf/gocode
go get -u github.com/rogpeppe/godef
go get -u golang.org/x/tools/cmd/guru
go get -u golang.org/x/tools/cmd/goimports
# language server
go get golang.org/x/tools/gopls@latest
# config
zshrc: GOPATH,GOPROXY
#+end_src

Format
#+begin_src emacs-lisp
;; Set up before-save hooks to format buffer and add/delete imports.
;; Make sure you don't have other gofmt/goimports hooks enabled.
(defun lsp-go-install-save-hooks ()
  (add-hook 'before-save-hook #'lsp-format-buffer t t)
  (add-hook 'before-save-hook #'lsp-organize-imports t t))
(add-hook 'go-mode-hook #'lsp-go-install-save-hooks)
#+end_src

Go uses tabs, so lets set the indent to a sane mode

#+begin_src emacs-lisp
(setq-default tab-width 4)
#+end_src

Packages that you need for a nice Go setup

#+begin_src emacs-lisp
(use-package go-mode
  :ensure t
  :bind (("C-c t t" . go-test-current-test)
         ("C-c t p" . go-test-current-project)
         ("C-c t c" . go-test-current-coverage)
         ("C-c t f" . go-test-current-file))
  :config
  (setq gofmt-command "goimports")
  (add-hook 'before-save-hook 'gofmt-before-save))

(use-package exec-path-from-shell
  :ensure t
  :config
  (exec-path-from-shell-copy-env "GOPATH")
  (exec-path-from-shell-copy-env "GOPROXY")
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize)))

(use-package go-guru
  :ensure t)

(use-package go-errcheck
  :ensure t)

;; Yasnippets
(use-package go-snippets
  :ensure t)

;; eldoc integration
(use-package go-eldoc
  :ensure t)

;; (use-package gocode
;;   :ensure t)

;; (use-package godef
;;   :ensure t)

(use-package gotest
  :ensure t)

(use-package flycheck-golangci-lint
  :ensure t
  :hook (go-mode . flycheck-golangci-lint-setup))
#+end_src
* Configuration and log files
This part is dedicated to unix and more general configuration files as well as logs.
** editor configs
#+begin_src emacs-lisp
  ;; Respect editor configs
  (use-package editorconfig
    :ensure t
    :diminish editorconfig-mode
    :config
    (editorconfig-mode 1))
#+end_src
** Default unix configuration
Config-general-mode is applied for all unix configuration files.
#+begin_src emacs-lisp
  (use-package config-general-mode
    :ensure t
    :mode ("\\.conf$" "\\.*rc$"))
#+end_src
** Apache
#+begin_src emacs-lisp
  (use-package apache-mode
    :ensure t
    :mode ("\\.htaccess\\'" "httpd\\.conf\\'" "srm\\.conf\\'"
           "access\\.conf\\'" "sites-\\(available\\|enabled\\)/"))
#+end_src
** SSH configuration
#+begin_src emacs-lisp
  (use-package ssh-config-mode
    :ensure t
    :mode ("/\\.ssh/config\\'" "/system/ssh\\'" "/sshd?_config\\'" "/known_hosts\\'" "/authorized_keys2?\\'")
    :hook (ssh-config-mode . turn-on-font-lock)

    :config
    (autoload 'ssh-config-mode "ssh-config-mode" t))
#+end_src
** Logview
#+begin_src emacs-lisp
  (use-package logview
    :ensure t
    :mode ("syslog\\(?:\\.[0-9]+\\)" "\\.log\\(?:\\.[0-9]+\\)?\\'"))
#+end_src
** systemd
#+begin_src emacs-lisp
(use-package systemd
  :ensure t
  :mode
  ("\\.service\\'" "\\.timer\\'" "\\.target\\'" "\\.mount\\'"
   "\\.automount\\'" "\\.slice\\'" "\\.socket\\'" "\\.path\\'"
   "\\.netdev\\'" "\\.network\\'" "\\.link\\'"))
#+end_src
** yaml
#+begin_src emacs-lisp
  (use-package yaml-mode
    :ensure t
    :mode (".yaml$")
    :hook
    (yaml-mode . yaml-mode-outline-hook)

    :init
    (defun yaml-outline-level ()
      "Return the outline level based on the indentation, hardcoded at 2 spaces."
      (s-count-matches "[ ]\\{2\\}" (match-string 0)))

    (defun yaml-mode-outline-hook ()
      (outline-minor-mode)
      (setq outline-regexp "^\\([ ]\\{2\\}\\)*\\([-] \\)?\\([\"][^\"]*[\"]\\|[a-zA-Z0-9_-]*\\): *\\([>|]\\|&[a-zA-Z0-9_-]*\\)?$")
      (setq outline-level 'yaml-outline-level))
    )

  (use-package yaml-tomato
    :ensure t)
#+end_src
** toml
#+begin_src emacs-lisp
  (use-package toml-mode
    :ensure t)
#+end_src
** vimrc
#+begin_src emacs-lisp
  (use-package vimrc-mode
    :ensure t
    :mode ("^\\.vimrc\\'"))
#+end_src
** CSS
#+begin_src emacs-lisp
  (use-package scss-mode
    :ensure t
    :defines scss-compile-at-save
    :mode ("\\.scss\\'")
    :config
    (setq scss-compile-at-save 'nil))
#+END_SRC
** CSV
 #+begin_src emacs-lisp
   (use-package csv-mode
     :ensure t
     :config

     ;; Define separators
     (setq csv-separators '("," ";" ":" " ")))


   ;; Subpackages
   (use-package csv-nav
     :ensure t
     :disabled t)
 #+end_src
** Graphviz
#+begin_src emacs-lisp
  (use-package graphviz-dot-mode
    :ensure t
    :init
    (defvar default-tab-width nil)

    :mode ("\\.dot\\'"))
#+end_src
